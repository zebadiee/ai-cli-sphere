name: Security Scan (Main)

on:
  push:
    branches: [ main ]

jobs:
  security-scan:
    name: Security & Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          curl -sSfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin

      - name: Run Trivy filesystem scan (SARIF)
        run: |
          trivy fs --format sarif --output trivy-results.sarif .

      - name: Upload scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif
          category: trivy

      - name: Run Bandit (Python security linter)
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-report.json || true

      - name: Check for critical security issues
        run: |
          python - <<'PY'
import json
import sys
try:
    with open('bandit-report.json') as f:
        data = json.load(f)
except FileNotFoundError:
    print('No bandit report found; skipping')
    sys.exit(0)
critical = [r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH' or r.get('issue_confidence') == 'HIGH']
if critical:
    print(f'❌ {len(critical)} critical security issues found')
    for r in critical:
        print(f"  - {r.get('issue_text')}")
    sys.exit(1)
else:
    print('✅ No critical security issues')
PY
